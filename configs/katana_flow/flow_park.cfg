# KATANA-FLOW: Smart Park
# Parks nozzle near the first print object.
# No retract — nozzle stays primed for purge.

[gcode_macro FLOW_PARK]
description: Park near first print object (KATANA-FLOW)
gcode:
    {% set z_hop = params.Z|default(10)|int %}

    {% if printer.exclude_object.objects %}
        # Find closest corner of all objects
        {% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
        {% set x_min = all_points | map(attribute=0) | min %}
        {% set y_min = all_points | map(attribute=1) | min %}

        # Offset 5mm from object edge
        {% set park_x = [x_min - 5, printer.toolhead.axis_minimum.x + 2] | max %}
        {% set park_y = [y_min - 5, printer.toolhead.axis_minimum.y + 2] | max %}

        M117 FLOW: Park X{park_x} Y{park_y}
        G90
        G0 Z{z_hop} F3000
        G0 X{park_x} Y{park_y} F6000
    {% else %}
        # No object data — park at front-left
        M117 FLOW: Park (no object data)
        G90
        G0 Z{z_hop} F3000
        G0 X5 Y5 F6000
    {% endif %}
