[gcode_macro ADAPTIVE_PURGE]
description: Purges a line based on nozzle diameter near the print object
gcode:
    # 1. Detect Nozzle Size (safe default 0.4)
    {% set nozzle_dia = 0.4 %}
    {% if printer.configfile.settings.extruder is defined %}
        {% set nozzle_dia = printer.configfile.settings.extruder.nozzle_diameter | default(0.4) | float %}
    {% endif %}
    
    # 2. Calculate Purge Flow
    # Factor: 0.4mm -> 1.0, 0.6mm -> 1.5, 0.8mm -> 2.0
    {% set purge_factor = nozzle_dia / 0.4 %}
    {% set purge_len = 50 %}
    {% set purge_vol = 10 * purge_factor %} # Adjust E-value scaling here

    # 3. Find Start Position (Near Object, same logic as Smart Park but reused or recalculated)
    {% set start_x = 10 %}
    {% set start_y = 10 %}
    
    {% if printer.exclude_object is defined and printer.exclude_object.objects %}
        {% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
        {% if all_points %}
             {% set start_x = (all_points | map(attribute=0) | min) - 10 %}
             {% set start_y = (all_points | map(attribute=1) | min) - 10 %}
        {% endif %}
    {% endif %}
    
    # Clamp
    {% if start_x < 5 %}{% set start_x = 5 %}{% endif %}
    {% if start_y < 5 %}{% set start_y = 5 %}{% endif %}

    # 4. Execute Purge
    M117 Purging for {nozzle_dia}mm nozzle...
    G92 E0
    G90
    G0 X{start_x} Y{start_y} Z{nozzle_dia * 0.75} F3000
    G1 X{start_x + purge_len} E{purge_vol} F1000  # Adaptive Extrusion
    G1 X{start_x + purge_len + 10} E{purge_vol * 0.1} F1000 # Wipe
    G92 E0
