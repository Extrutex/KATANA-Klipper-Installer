[gcode_macro SMART_PARK]
description: Parks the toolhead near the print object to minimize travel
variable_park_height: 10
gcode:
    {% set safe_z = printer.toolhead.axis_maximum.z|float %}
    {% set current_z = printer.toolhead.position.z|float %}
    
    # 1. Get Print Boundaries (computed by slicer/Moonraker and ExcludeObject)
    # Default to center if no object
    {% set min_x = 100 %} 
    {% set min_y = 100 %}
    
    {% if printer.exclude_object is defined and printer.exclude_object.objects %}
        {% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
        # Check if we have points
        {% if all_points %}
             {% set min_x = all_points | map(attribute=0) | min %}
             {% set min_y = all_points | map(attribute=1) | min %}
        {% endif %}
    {% endif %}

    # 2. Calculate "Smart" Park Position (Nearest Corner outside print area - 10mm buffer)
    {% set park_x = min_x - 10 %}
    {% set park_y = min_y - 10 %}
    
    # Clamp to safe limits (Min: 0 + 5mm)
    {% if park_x < 5 %}{% set park_x = 5 %}{% endif %}
    {% if park_y < 5 %}{% set park_y = 5 %}{% endif %}

    # 3. Execute Park
    G90
    G0 Z{ [current_z + park_height, safe_z] | min } F600
    G0 X{park_x} Y{park_y} F6000
