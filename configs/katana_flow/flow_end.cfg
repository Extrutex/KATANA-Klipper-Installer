# KATANA-FLOW: Smart End
# Usage in slicer End G-Code:
#   FLOW_END
#
# Handles: Retract → Raise → Present → Cooldown → Idle

[gcode_macro FLOW_END]
description: Complete print end sequence (KATANA-FLOW)
gcode:
    {% set z_max = printer.toolhead.axis_maximum.z %}
    {% set z_cur = printer.toolhead.position.z %}
    {% set z_safe = [z_cur + 20, z_max - 5] | min %}
    {% set y_max = printer.toolhead.axis_maximum.y %}

    M117 FLOW: Finishing
    G92 E0

    # Retract + raise
    G91
    G1 E-5 F3000                     ; Retract
    G90
    G0 Z{z_safe} F3000               ; Raise

    # Present part — bed forward
    G0 X10 Y{y_max - 10} F6000

    # Cooldown
    M400                              ; Wait for moves
    M140 S0                           ; Bed off
    M104 S0                           ; Nozzle off
    M106 S0                           ; Fan off

    # Disable steppers after 5 min
    M84 S300

    M117 Done.
